# Per-User Add-on Architecture: Visual Overview

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Telegram Bot User                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ /addon search weather
                           â”‚ /addon install weather-api
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Bot Handlers (bot_handlers.py)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ cmd_addon()                                                   â”‚  â”‚
â”‚  â”‚  - Parse subcommand (search|install|list|remove|info|update) â”‚  â”‚
â”‚  â”‚  - Route to AddonManager                                      â”‚  â”‚
â”‚  â”‚  - Format response with rich text                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AddonManager (addon_manager.py)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ install(name, version)                                      â”‚  â”‚
â”‚  â”‚ â€¢ uninstall(name)                                             â”‚  â”‚
â”‚  â”‚ â€¢ list_installed()                                            â”‚  â”‚
â”‚  â”‚ â€¢ enable(name) / disable(name)                                â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚ Manages:                                                       â”‚  â”‚
â”‚  â”‚  - ./workspaces/{user_id}/.kiro/skills/                      â”‚  â”‚
â”‚  â”‚  - ./workspaces/{user_id}/addons.json                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                   â”‚
          â”‚ KiroHub operations                â”‚ Local operations
          â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KiroHubClient              â”‚    â”‚ UserAddonRegistry                â”‚
â”‚ (kirohub_client.py)        â”‚    â”‚ (addon_models.py)                â”‚
â”‚                            â”‚    â”‚                                  â”‚
â”‚ â€¢ search(query)            â”‚    â”‚ â€¢ load(path)                     â”‚
â”‚ â€¢ install(name, target)    â”‚    â”‚ â€¢ save(path)                     â”‚
â”‚ â€¢ get_info(name)           â”‚    â”‚ â€¢ find(name)                     â”‚
â”‚ â€¢ get_versions(name)       â”‚    â”‚ â€¢ add(addon)                     â”‚
â”‚                            â”‚    â”‚ â€¢ remove(name)                   â”‚
â”‚ Wraps: npx kirohub CLI     â”‚    â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ npx kirohub search/install
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      KiroHub Registry (kirohub.dev)                 â”‚
â”‚                                                                     â”‚
â”‚  Add-on Marketplace:                                                â”‚
â”‚   â€¢ weather-api v2.1.0                                              â”‚
â”‚   â€¢ web-search v1.5.3                                               â”‚
â”‚   â€¢ translate-text v0.8.1                                           â”‚
â”‚   â€¢ ... (hundreds more)                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Workspace Structure

```
./workspaces/
â”‚
â”œâ”€â”€ user_123/                          # User 123's workspace
â”‚   â”œâ”€â”€ .kiro/                         # User-specific Kiro home
â”‚   â”‚   â”œâ”€â”€ agents/      â†’ ~/.kiro/agents/    (symlink to global)
â”‚   â”‚   â”œâ”€â”€ steering/    â†’ ~/.kiro/steering/  (symlink to global)
â”‚   â”‚   â””â”€â”€ skills/                   # User-installed add-ons
â”‚   â”‚       â”œâ”€â”€ weather-api/
â”‚   â”‚       â”‚   â”œâ”€â”€ skill.json
â”‚   â”‚       â”‚   â”œâ”€â”€ weather.py
â”‚   â”‚       â”‚   â””â”€â”€ requirements.txt
â”‚   â”‚       â””â”€â”€ web-search/
â”‚   â”‚           â”œâ”€â”€ skill.json
â”‚   â”‚           â””â”€â”€ search.py
â”‚   â”‚
â”‚   â”œâ”€â”€ addons.json                   # User's add-on registry
â”‚   â”‚   {
â”‚   â”‚     "version": "1.0",
â”‚   â”‚     "addons": [
â”‚   â”‚       {
â”‚   â”‚         "name": "weather-api",
â”‚   â”‚         "version": "2.1.0",
â”‚   â”‚         "installedAt": "2026-02-16T19:00:00Z",
â”‚   â”‚         "enabled": true
â”‚   â”‚       },
â”‚   â”‚       ...
â”‚   â”‚     ]
â”‚   â”‚   }
â”‚   â”‚
â”‚   â”œâ”€â”€ thread_1/                     # Thread workspaces
â”‚   â”‚   â””â”€â”€ [files...]
â”‚   â””â”€â”€ thread_2/
â”‚       â””â”€â”€ [files...]
â”‚
â””â”€â”€ user_456/                          # User 456's workspace
    â”œâ”€â”€ .kiro/
    â”‚   â”œâ”€â”€ agents/      â†’ ~/.kiro/agents/
    â”‚   â”œâ”€â”€ steering/    â†’ ~/.kiro/steering/
    â”‚   â””â”€â”€ skills/                   # Different add-ons!
    â”‚       â””â”€â”€ translate-text/
    â”‚           â”œâ”€â”€ skill.json
    â”‚           â””â”€â”€ translate.py
    â”‚
    â”œâ”€â”€ addons.json
    â””â”€â”€ thread_1/
        â””â”€â”€ [files...]
```

**Key Points:**
- Each user has isolated `.kiro/skills/` directory
- Global `agents` and `steering` are symlinked (shared config)
- Each user can install different add-ons
- Add-on metadata tracked in per-user `addons.json`

---

## Skill Resolution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User sends message in Telegram thread                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProcessPool.execute_request(                                    â”‚
â”‚   thread_id=123,                                                â”‚
â”‚   user_id=456,  â—„â”€â”€â”€ User ID passed to process pool            â”‚
â”‚   message="What's the weather?"                                 â”‚
â”‚ )                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACPClient spawns kiro-cli with custom environment:             â”‚
â”‚                                                                 â”‚
â”‚   env = {                                                       â”‚
â”‚     "KIRO_HOME": "./workspaces/456/.kiro",  â—„â”€â”€â”€ User-specific â”‚
â”‚     ...                                                         â”‚
â”‚   }                                                             â”‚
â”‚                                                                 â”‚
â”‚   $ KIRO_HOME=./workspaces/456/.kiro kiro-cli acp              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kiro CLI loads skills from:                                     â”‚
â”‚                                                                 â”‚
â”‚  1. $KIRO_HOME/skills/  (./workspaces/456/.kiro/skills/)       â”‚
â”‚     â”œâ”€â”€ weather-api/     â—„â”€â”€â”€ User's installed add-ons         â”‚
â”‚     â””â”€â”€ web-search/                                             â”‚
â”‚                                                                 â”‚
â”‚  2. ~/.kiro/skills/      (global fallback)                     â”‚
â”‚     â””â”€â”€ [default skills]                                        â”‚
â”‚                                                                 â”‚
â”‚  User skills override global skills (if same name)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kiro CLI processes message using available tools:              â”‚
â”‚   â€¢ weather-api: get_current_weather(location)                 â”‚
â”‚   â€¢ web-search: search_web(query)                              â”‚
â”‚   â€¢ [default tools from global skills]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response streamed back to Telegram user                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Add-on Installation Flow

```
User: /addon install weather-api
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bot_handlers.cmd_addon()                         â”‚
â”‚  - Parse: subcommand="install", name="weather-api"â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Send immediate feedback:                         â”‚
â”‚ "ğŸ“¦ Installing weather-api..."                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AddonManager.install("weather-api")              â”‚
â”‚                                                  â”‚
â”‚  1. Check if already installed                   â”‚
â”‚  2. Check quota (< 20 addons)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KiroHubClient.install(                           â”‚
â”‚   name="weather-api",                            â”‚
â”‚   target_dir="./workspaces/456/.kiro/skills/",  â”‚
â”‚   version=None  # latest                         â”‚
â”‚ )                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ npx kirohub install weather-api \
                    â”‚   --target ./workspaces/456/.kiro/skills/ \
                    â”‚   --json
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KiroHub Registry (kirohub.dev)                   â”‚
â”‚                                                  â”‚
â”‚  1. Resolve latest version (2.1.0)              â”‚
â”‚  2. Download package                             â”‚
â”‚  3. Extract to target directory                  â”‚
â”‚  4. Return metadata                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Returns: { name, version, ... }
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AddonManager                                     â”‚
â”‚                                                  â”‚
â”‚  3. Verify installation                          â”‚
â”‚  4. Update addons.json registry                  â”‚
â”‚  5. Return AddonMetadata                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Telegram message:                         â”‚
â”‚ "âœ… Installed weather-api v2.1.0                â”‚
â”‚                                                  â”‚
â”‚  ğŸ“š Available tools:                             â”‚
â”‚    â€¢ get_current_weather(location)              â”‚
â”‚    â€¢ get_forecast(location, days)               â”‚
â”‚                                                  â”‚
â”‚  ğŸ’¡ Try: 'What's the weather in SF?'"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: User Message Processing

```
1. User Message
   â†“
2. Bot Handler (identify user_id, thread_id)
   â†“
3. ProcessPool (get/create process for thread)
   â†“
4. ACPClient.spawn_process(env={"KIRO_HOME": user_kiro_home})
   â†“
5. kiro-cli loads skills from user_kiro_home/skills/
   â†“
6. kiro-cli processes message with user's add-ons
   â†“
7. Response streamed back through ProcessPool
   â†“
8. StreamWriter formats for Telegram
   â†“
9. User receives response
```

---

## Component Dependencies

```
bot_handlers.py
    â”œâ”€â–º addon_manager.py
    â”‚       â”œâ”€â–º addon_models.py (AddonMetadata, UserAddonRegistry)
    â”‚       â”œâ”€â–º kirohub_client.py (search, install, etc.)
    â”‚       â””â”€â–º addon_exceptions.py (error classes)
    â”‚
    â””â”€â–º process_pool.py
            â””â”€â–º acp_client.py (custom KIRO_HOME)
                    â””â”€â–º provisioner.py (user Kiro home setup)
```

---

## Security Boundaries

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Telegram User                        â”‚
â”‚                                                          â”‚
â”‚  Trust Level: UNTRUSTED                                  â”‚
â”‚  Can: Install any add-on from KiroHub                   â”‚
â”‚  Cannot: Access other users' add-ons or workspaces      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Commands validated
                        â”‚ (name, version format)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Bot (Python Process)                   â”‚
â”‚                                                          â”‚
â”‚  Trust Level: TRUSTED                                    â”‚
â”‚  Enforces:                                               â”‚
â”‚   â€¢ User quota limits                                    â”‚
â”‚   â€¢ Addon size limits                                    â”‚
â”‚   â€¢ Path traversal prevention                            â”‚
â”‚   â€¢ Per-user isolation                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ npx kirohub (sandboxed)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   KiroHub Registry                       â”‚
â”‚                                                          â”‚
â”‚  Trust Level: SEMI-TRUSTED                               â”‚
â”‚  Provides:                                               â”‚
â”‚   â€¢ Package verification                                 â”‚
â”‚   â€¢ Version management                                   â”‚
â”‚   â€¢ (Future) Package signing                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Addon code
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              kiro-cli (per-user process)                 â”‚
â”‚                                                          â”‚
â”‚  Trust Level: UNTRUSTED (user-installed code)            â”‚
â”‚  Isolation:                                              â”‚
â”‚   â€¢ Custom KIRO_HOME (isolated skills)                  â”‚
â”‚   â€¢ (Future) Resource limits (CPU, memory)               â”‚
â”‚   â€¢ (Future) Filesystem sandbox                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Future Enhancements

### Phase 5: Advanced Features
- Add-on dependency resolution
- Private add-on registries
- Add-on ratings and reviews
- Automatic updates
- Add-on sandboxing (resource limits)

### Phase 6: Developer Experience
- Add-on publishing CLI
- Local add-on development workflow
- Add-on testing framework
- Documentation generator

### Phase 7: Marketplace
- Web interface for browsing add-ons
- Usage analytics for developers
- Featured add-ons
- Collections/bundles

---

## Comparison: Before vs After

### Before (Global Skills Only)

```
~/.kiro/skills/
  â”œâ”€â”€ default-skill-1/
  â””â”€â”€ default-skill-2/

All users share same skills
Admin must deploy to add new skills
No user customization
```

### After (Per-User Add-ons)

```
~/.kiro/skills/           # Global (default)
  â”œâ”€â”€ default-skill-1/
  â””â”€â”€ default-skill-2/

./workspaces/user_1/.kiro/skills/  # User 1's add-ons
  â”œâ”€â”€ weather-api/
  â””â”€â”€ web-search/

./workspaces/user_2/.kiro/skills/  # User 2's add-ons
  â””â”€â”€ translate-text/

Each user has customized toolset
Self-service installation
No admin intervention needed
```

---

## Summary

This architecture enables:
âœ… **Isolation**: Each user has independent add-on set
âœ… **Self-Service**: Users install add-ons via chat
âœ… **Discovery**: Browse add-ons from KiroHub
âœ… **Versioning**: Track and update add-ons
âœ… **Backward Compatible**: Global skills still work
âœ… **Scalable**: No admin overhead for add-ons

**Result**: Empowered users + reduced admin burden + thriving add-on ecosystem
